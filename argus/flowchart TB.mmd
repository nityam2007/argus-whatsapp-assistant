flowchart TB
    %% ============ EXTERNAL SOURCES ============
    WA["ğŸ“± WhatsApp Messages"]
    CHROME["ğŸŒ Chrome Browser"]

    %% ============ EVOLUTION API ============
    subgraph EVOL ["âš¡ Evolution API :8080"]
        direction LR
        EVOL_SVC["Evolution API"]
        PG[("PostgreSQL")]
        EVOL_SVC <--> PG
    end

    %% ============ ARGUS SERVER ============
    subgraph ARGUS ["ğŸ§  Argus Server :3000"]
        direction TB

        %% --- Ingestion Pipeline ---
        subgraph INGEST ["ğŸ“¥ Ingestion Pipeline"]
            direction TB
            WH["Webhook Receiver\n/api/webhook/whatsapp"]
            PREFILTER["shouldSkipMessage()\nTrivial Pre-filter\nempty Â· emoji Â· 'ok' Â· 'lol'"]
            DETECT["detectAction()\nCancel / Done / Snooze / Ignore"]
            ANALYZE["analyzeMessage()\nSingle Gemini Call\nClassify + Extract Unified"]
            DEDUP["findDuplicateEvent()\n48h Title Similarity Check"]
            CONF_GATE["Confidence Gate\nthreshold â‰¥ 0.65"]
            CONFLICT["checkEventConflicts()\n60min Window"]
            SAVE["insertEvent() + insertTrigger()"]
        end

        %% --- AI Engine ---
        subgraph AI ["ğŸ¤– Gemini AI Engine"]
            direction TB
            GEMINI["Gemini 3 Flash Preview\n+ System Prompt"]
            GEN_POPUP["generatePopupBlueprint()\nFull Popup Spec via AI\nicon Â· title Â· buttons Â· styles"]
            VALIDATE["validateRelevance()\nURL â†” Event Matching"]
            AI_CHAT["chatWithContext()\nNatural Language Q&A"]
        end

        %% --- Scheduler ---
        subgraph SCHED ["â° Scheduler"]
            direction TB
            TIME_CHK["checkTimeTriggers()\n24h Â· 1h Â· 15m intervals"]
            REM_CHK["checkDueReminders()\n30s poll"]
            SNOOZE_CHK["checkSnoozedEvents()\n30s poll"]
        end

        %% --- Data Layer ---
        subgraph DATA ["ğŸ’¾ Data Layer"]
            direction LR
            SQLITE[("SQLite + FTS5")]
            DB_OPS["db.ts CRUD"]
            DB_OPS <--> SQLITE
        end

        %% --- REST API ---
        subgraph API ["ğŸ”Œ REST API"]
            direction TB
            EP_EVENTS["/api/events\n/api/events/:id"]
            EP_STATS["/api/stats\n/api/health"]
            EP_ACTIONS["/api/events/:id/action\ncomplete Â· snooze Â· ignore Â· dismiss"]
            EP_CHAT["/api/chat"]
            EP_CTX["/api/context-check"]
            EP_DAY["/api/events/day/:timestamp"]
        end

        WS["ğŸ”— WebSocket /ws"]
    end

    %% ============ CHROME EXTENSION ============
    subgraph EXT ["ğŸ§© Chrome Extension Â· Manifest V3"]
        direction TB

        subgraph BG ["Service Worker"]
            direction LR
            BG_JS["background.js"]
            WS_CLI["WebSocket Client"]
            BG_JS <--> WS_CLI
        end

        subgraph CS ["Content Script â€” Pure Renderer"]
            direction TB
            CS_JS["content.js"]
            POPUP["API-Driven Popup\nRenders blueprint from server\nNo hardcoded templates"]
            TOAST["Toast Notifications"]
            DAY_VIEW["View My Day\nColor-coded Timeline"]
        end

        subgraph SIDE ["AI Chat Sidebar"]
            direction LR
            SP_HTML["sidepanel.html"]
            SP_JS["sidepanel.js"]
        end

        subgraph EXT_POP ["Extension Popup"]
            direction LR
            POP_HTML["popup.html"]
            POP_JS["popup.js"]
        end
    end

    %% ============ 3 CORE SCENARIOS ============
    subgraph SCENARIOS ["ğŸ¯ 3 Core Scenarios"]
        direction LR
        S1["ğŸ¥œ Goa Cashew\nRecommendation â†’ URL trigger\non travel/goa sites"]
        S4["ğŸ“º Netflix Cancel\nSubscription â†’ URL trigger\non netflix.com"]
        S5["ğŸ“… Calendar Conflict\nInformal dinner commitment â†’\nConflict when new meeting overlaps"]
    end

    %% ============ INGESTION FLOW ============
    WA -->|"messages"| EVOL_SVC
    EVOL_SVC -->|"webhook POST"| WH
    WH --> PREFILTER
    PREFILTER -->|"âŒ trivial message"| SKIP_MSG["â­ï¸ Skip"]
    PREFILTER -->|"âœ… non-trivial"| DETECT
    DETECT -->|"action found"| ACTION_EXEC["Execute on DB\ndelete Â· complete Â· snooze"]
    DETECT -->|"no action"| ANALYZE
    ANALYZE -->|"AI call"| GEMINI
    ANALYZE --> CONF_GATE
    CONF_GATE -->|"< 0.65 â†’ reject"| SKIP_LOW["â­ï¸ Low Confidence"]
    CONF_GATE -->|"â‰¥ 0.65 â†’ check dedup"| DEDUP
    DEDUP -->|"duplicate found â†’ skip"| SKIP_DUP["â­ï¸ Duplicate"]
    DEDUP -->|"unique â†’ save"| SAVE
    SAVE --> CONFLICT
    CONFLICT -->|"overlap detected"| GEN_POPUP
    SAVE --> DB_OPS
    SAVE -->|"new event"| GEN_POPUP

    %% ============ POPUP BLUEPRINT FLOW ============
    GEN_POPUP -->|"AI call"| GEMINI
    GEN_POPUP -->|"popup blueprint\nicon Â· title Â· buttons Â· styles"| WS

    %% ============ AI ENGINE CONNECTIONS ============
    DETECT -->|"AI call"| GEMINI
    AI_CHAT -->|"AI call"| GEMINI
    VALIDATE -->|"AI call"| GEMINI
    VALIDATE --> DB_OPS

    %% ============ SCHEDULER â†’ DATA â†’ WS ============
    TIME_CHK --> DB_OPS
    REM_CHK --> DB_OPS
    SNOOZE_CHK --> DB_OPS
    SCHED -->|"event due"| GEN_POPUP

    %% ============ WS â†” EXTENSION ============
    WS_CLI <-->|"WebSocket :3000/ws"| WS
    WS_CLI -->|"popup blueprint"| CS_JS
    WS_CLI -->|"notifications"| BG_JS

    %% ============ EXTENSION â†’ API ============
    CS_JS --> POPUP
    CS_JS --> TOAST
    CS_JS --> DAY_VIEW
    SP_JS -->|"POST /api/chat"| EP_CHAT
    POP_JS -->|"GET /api/events"| EP_EVENTS
    POP_JS -->|"GET /api/stats"| EP_STATS
    CS_JS -->|"POST /api/events/:id/action"| EP_ACTIONS

    %% ============ CONTEXT TRIGGER FLOW ============
    CHROME -->|"URL changes"| BG_JS
    BG_JS -->|"POST /api/context-check"| EP_CTX
    EP_CTX -->|"validate"| VALIDATE
    EP_CTX -->|"matching events"| GEN_POPUP
    BG_JS -->|"context popup"| CS_JS

    %% ============ API â†’ DATA ============
    EP_CHAT --> AI_CHAT
    EP_ACTIONS --> DB_OPS
    EP_EVENTS --> DB_OPS
    EP_STATS --> DB_OPS
    EP_DAY --> DB_OPS
    ACTION_EXEC --> DB_OPS

    %% ============ SCENARIO TRIGGERS ============
    S1 -.->|"travel site URL match"| EP_CTX
    S4 -.->|"netflix.com URL match"| EP_CTX
    S5 -.->|"time overlap check"| CONFLICT